{{> pre-body}}
<div class="drawer drawer-mobile">
    <ul id="contextMenu" class="menu bg-base-100 w-56 hidden absolute z-10">
        <li id="replyButton"><a href="#">Reply</a></li>
    </ul>
    <input id="drawer-toggle" type="checkbox" class="drawer-toggle"/>

    <div class="drawer-content flex flex-col p-2">

        <div class="messages-container-wrapper flex-1 min-h-0 overflow-auto py-2">

            <div class="messages-container flex flex-col justify-end min-h-full">
            </div>
        </div>
        <div id="repliedMessageContainer" class="alert shadow-lg hidden">
            <div id="repliedMessageSection">
                <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                </svg>
                <span></span>
            </div>
        </div>
        <form>
            <input class="input input-bordered input-primary w-full" id="message-input" type="text"
                   placeholder="type something..." autocomplete="off">
        </form>
    </div>

    <div class="drawer-side ">
        <label for="drawer-toggle" class="drawer-overlay"></label>

        <div id="drawer-tabs" class="bg-base-200 pt-10 lg:pt-0 lg:w-80">
            <div class="tabs tabs-boxed p-4 w-full flex">
                <a class="tab flex-1" data-tab-opener="user-list">Users</a>
                <a class="tab flex-1" data-tab-opener="settings">Settings</a>
            </div>
            <ul id="user-list" class="menu p-4 w-full text-base-content" data-tab="user-list">
            </ul>
            <div class="p-4 w-full" data-tab="settings">
                <button class="btn bg-white bg-opacity-10 border-transparent text-white w-full"
                        onclick="usernameModal.showModal()">
                    <svg class="w-7 h-7 mr-3 fill-violet-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M10 4A4 4 0 0 0 6 8A4 4 0 0 0 10 12A4 4 0 0 0 14 8A4 4 0 0 0 10 4M10 6A2 2 0 0 1 12 8A2 2 0 0 1 10 10A2 2 0 0 1 8 8A2 2 0 0 1 10 6M17 12C16.84 12 16.76 12.08 16.76 12.24L16.5 13.5C16.28 13.68 15.96 13.84 15.72 14L14.44 13.5C14.36 13.5 14.2 13.5 14.12 13.6L13.16 15.36C13.08 15.44 13.08 15.6 13.24 15.68L14.28 16.5V17.5L13.24 18.32C13.16 18.4 13.08 18.56 13.16 18.64L14.12 20.4C14.2 20.5 14.36 20.5 14.44 20.5L15.72 20C15.96 20.16 16.28 20.32 16.5 20.5L16.76 21.76C16.76 21.92 16.84 22 17 22H19C19.08 22 19.24 21.92 19.24 21.76L19.4 20.5C19.72 20.32 20.04 20.16 20.28 20L21.5 20.5C21.64 20.5 21.8 20.5 21.8 20.4L22.84 18.64C22.92 18.56 22.84 18.4 22.76 18.32L21.72 17.5V16.5L22.76 15.68C22.84 15.6 22.92 15.44 22.84 15.36L21.8 13.6C21.8 13.5 21.64 13.5 21.5 13.5L20.28 14C20.04 13.84 19.72 13.68 19.4 13.5L19.24 12.24C19.24 12.08 19.08 12 19 12H17M10 13C7.33 13 2 14.33 2 17V20H11.67C11.39 19.41 11.19 18.77 11.09 18.1H3.9V17C3.9 16.36 7.03 14.9 10 14.9C10.43 14.9 10.87 14.94 11.3 15C11.5 14.36 11.77 13.76 12.12 13.21C11.34 13.08 10.6 13 10 13M18.04 15.5C18.84 15.5 19.5 16.16 19.5 17.04C19.5 17.84 18.84 18.5 18.04 18.5C17.16 18.5 16.5 17.84 16.5 17.04C16.5 16.16 17.16 15.5 18.04 15.5Z"/>
                    </svg>
                    Change the profile name
                </button>
            </div>
        </div>

    </div>

</div>
<label for="drawer-toggle" class="fixed top-4 right-4 btn btn-sm bg-opacity-30 btn-square hover:bg-opacity-30 bg-black hover:bg-black border-none lg:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-5 h-5 stroke-current">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
</label>
<dialog id="username_modal" tabindex="-1"
        class="fixed p-0 w-80 bg-transparent backdrop:bg-black backdrop:bg-opacity-40">
    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
        <button type="button" class="absolute top-3 right-2.5  text-gray-400 bg-transparent
                    rounded-lg text-sm p-1.5 ml-auto inline-flex items-center
                    hover:bg-gray-800 hover:text-white" onclick="usernameModal.close()">
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
                 xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd"
                      d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                      clip-rule="evenodd"></path>
            </svg>
        </button>
        <div class="p-6 text-center">
            <svg aria-hidden="false" class="mx-auto mb-4 fill-violet-400 text-gray-400 w-14 h-14 dark:text-gray-200"
                 xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 24 24">
                <path d="M20,11H23V13H20V11M1,11H4V13H1V11M13,1V4H11V1H13M4.92,3.5L7.05,5.64L5.63,7.05L3.5,4.93L4.92,3.5M16.95,5.63L19.07,3.5L20.5,4.93L18.37,7.05L16.95,5.63M12,6A6,6 0 0,1 18,12C18,14.22 16.79,16.16 15,17.2V19A1,1 0 0,1 14,20H10A1,1 0 0,1 9,19V17.2C7.21,16.16 6,14.22 6,12A6,6 0 0,1 12,6M14,21V22A1,1 0 0,1 13,23H11A1,1 0 0,1 10,22V21H14M11,18H13V15.87C14.73,15.43 16,13.86 16,12A4,4 0 0,0 12,8A4,4 0 0,0 8,12C8,13.86 9.27,15.43 11,15.87V18Z"/>
            </svg>
            <h3 class="mb-5 text-lg font-normal text-gray-400">Make up a new name</h3>
            <input class="block h-10 mb-4 w-full input input-bordered" type="text"
                   id="username"
                   name="username">
            <button type="button" class="block w-full mb-2 btn bg-violet-500 bg-opacity-60 border-transparent hover:bg-opacity-80
                            hover:bg-violet-500 hover:border-transparent text-gray-300">Submit
            </button>
        </div>
    </div>

</dialog>


<script>
    const usernameModal = document.querySelector("#username_modal");
    const repliedMessageContainer = document.querySelector("#repliedMessageContainer");
    const contextMenu = document.querySelector("#contextMenu");
    const drawer = document.querySelector(".drawer");
    const userList = document.querySelector("#user-list");
    const messagesContainer = document.querySelector(".messages-container");
    const messageInput = document.querySelector("#message-input");
    const messagesContainerWrapper = document.querySelector(".messages-container-wrapper");
    const MESSAGES_COLORS = [
        'bg-primary',
        'bg-primary-focus',
        'bg-secondary',
        'bg-secondary-focus',
    ];
    let users = [];
    const messages = {};
    let repliedMessage;
    let bottom = true;

    usernameModal.addEventListener('pointerdown', (e) => {
        if (e.target.contains(usernameModal)) {
            usernameModal.close();
        }
    })
    document.addEventListener('click', (e) => {
        contextMenu.classList.add("hidden");
    })

    document.querySelectorAll("#drawer-tabs [data-tab-opener]").forEach(tab => {
        tab.addEventListener('click', () => {
            setTab(tab.getAttribute("data-tab-opener"));
        })
    })

    function setTab(tabName) {
        document.querySelectorAll("#drawer-tabs [data-tab]").forEach(tabContent => {
            if (tabContent.getAttribute("data-tab") === tabName) {
                tabContent.classList.remove("hidden");
            } else {
                tabContent.classList.add("hidden");
            }
        })
        document.querySelectorAll("#drawer-tabs [data-tab-opener]").forEach(tabOpener => {
            if (tabOpener.getAttribute("data-tab-opener") === tabName) {
                tabOpener.classList.add("tab-active");
            } else {
                tabOpener.classList.remove("tab-active");
            }
        })
    }

    setTab("user-list");

    function showCustomContextMenu(id, event) {
        contextMenu.classList.remove("hidden");
        repliedMessage = messages[id];
        contextMenu.style.left = event.pageX + "px";
        contextMenu.style.top = event.pageY + "px";
        event.preventDefault();
    }

    function hideCustomContextMenu() {
        contextMenu.classList.add("hidden");
    }

    drawer.addEventListener('contextmenu', (e) => {
        if (e.target.classList.contains('.chat-bubble') ||
            // ??
            e.target.closest('.chat-bubble') !== null) {
            contextMenu.classList.remove("hidden");
        } else {
            contextMenu.classList.add("hidden");
        }
    });

    function addRepliedMessageSection() {
        document.querySelector("#replyButton").addEventListener('click', () => {
            repliedMessageContainer.classList.remove("hidden");
            document.querySelector("#repliedMessageSection span").innerHTML = repliedMessage.message;

        });
    }


    function displayUsers() {
        let userListHtml = "";
        for (const user of users) {
            const online = Date.now() - user.lastActivityAt < 30000;
            userListHtml += `
                 <li class="border rounded-xl mb-2 ${online ? 'border-primary' : 'border-gray-400'}">
                    <a class="flex justify-between">
                       <strong>${user.username}</strong>
                       <i class="w-3 h-3 rounded-full ${online ? 'bg-primary' : 'bg-gray-400'}"></i>
                    </a>
                 </li>
                `;
        }
        userList.innerHTML = userListHtml;
    }

    setInterval(displayUsers, 1000);

    function randomMessageColor() {
        return MESSAGES_COLORS[Math.floor(Math.random() * MESSAGES_COLORS.length)]
    }

    fetch("/api/users")
        .then(r => r.json())
        .then(r => {
            users = r.users;
            displayUsers();
        });

    document.querySelector('form').addEventListener("submit", function (event) {
        event.preventDefault();
        const message = messageInput.value;
        if (!message) {
            return;
        }
        const body = {message};
        if (!repliedMessageContainer.classList.contains("hidden")) {
            body.repliedMessageId = repliedMessage.id;
            repliedMessageContainer.classList.add("hidden");
        }
        fetch("/api/messages", {
            method: "POST",
            body: JSON.stringify(body),
            //TODO read about content type
            headers: {
                "Content-Type": "application/json;charset=UTF8"
            }
        });
        messageInput.value = "";
    });

    function addMessage(message) {
        const repliedMessage = message.repliedMessage;
        let repliedMessageHTML = "";

        if (message.repliedMessage) {
            repliedMessageHTML = `
               <div class="flex gap-2 w-auto bg-black bg-opacity-25 rounded-lg p-4 text-sm text-gray-300 mb-1">
                  <i class="block h-100 bg-white bg-opacity-20 rounded-md w-1 mt-1" style="min-width: 4px;"></i>
                     <div>
                       <div class="font-semibold mb-1 break-all">${repliedMessage.username}</div>
                       <div class="break-all">${repliedMessage.message}</div>
                     </div>
               </div>
        `
        }
        let messageHTML = `
               <div class="chat chat-start">
                 <div class="chat-header font-bold mb-1 break-all">${message.username}</div>
                   <div oncontextmenu="showCustomContextMenu('${message.id}', event)"
                        onclick="hideCustomContextMenu()"
                        class="chat-bubble w-auto max-w-4xl text-gray-200 break-all ${randomMessageColor()}">
                               ${repliedMessageHTML}
                               ${message.message}
                 </div>
               </div>
        `;
        addRepliedMessageSection();
        if (bottom === false) {
            messagesContainer.innerHTML = messageHTML + messagesContainer.innerHTML;
        } else {
            messagesContainer.innerHTML += messageHTML;
        }
    }

    messagesContainerWrapper.addEventListener('scroll', function () {
        console.log(messagesContainerWrapper.scrollTop)
        if (messagesContainerWrapper.scrollTop === 0) {
            // вернет массив сообщений
            const from = Object.values(messages).reduce(function (acc, curr) {
                return !acc || acc > curr.sendDate ? curr.sendDate : acc;
            }, null)
            displayMessages(from);
        }
    })

    function displayMessages(from) {
        const params = {count: 20}
        if (from) {
            params.from = from;
        }
        return fetch(`/api/messages?${new URLSearchParams(params).toString()}`)
            .then(r => r.json())
            .then(r => {
                for (const message of r.messages) {
                    bottom = false;
                    messages[message.id] = message;
                    addMessage(message);
                }
            })

    }

    displayMessages().then(() => {
        const ts = Object.values(messages).reduce(function (acc, curr) {
            return !acc || acc < curr.sendDate ? curr.sendDate : acc;
        }, 0)
        poll(ts);
    });

    function poll(ts) {
        fetch(`/api/events?ts=${ts}`)
            .then(r => r.json())
            .then(r => {
                for (const event of r.events) {
                    if (ts < event.date) {
                        ts = event.date;
                    }
                    switch (event.type) {
                        case "NEW_MESSAGE":
                            const message = event.message;
                            bottom = true;
                            messages[message.id] = message;
                            addMessage(message);
                            break;
                        case "USER_ACTIVITY":
                            const user = users.find(u => u.username === event.username);
                            if (user) {
                                user.lastActivityAt = event.date;
                            } else {
                                users = [{
                                    username: event.username,
                                    lastActivityAt: event.date
                                }, ...users];
                            }
                            break;
                    }
                }
                requestAnimationFrame(() => messagesContainerWrapper.scrollTo({
                    top: messagesContainerWrapper.scrollHeight,
                    behavior: 'smooth'
                }))
                poll(ts);
            })
    }
</script>
{{> post-body}}