{{#partial "body"}}
<div class="drawer drawer-mobile">
    <input id="my-drawer-2" type="checkbox" class="drawer-toggle"/>
    <div class="drawer-content flex flex-col p-2">
        <div class="messages-container-wrapper flex-1 min-h-0 overflow-auto py-2">
            <div class="messages-container flex flex-col justify-end min-h-full">
            </div>
        </div>
        <form>
            <input class="input input-bordered input-primary w-full" id="message-input" type="text"
                   placeholder="type something..." autocomplete="off">
        </form>
    </div>
    <div class="drawer-side">
        <label for="my-drawer-2" class="drawer-overlay"></label>
        <div class="bg-base-200">
            <h2 class="text-2xl max-h-8 text-center pt-2">Users</h2>
            <ul id="user-list" class="menu p-4 w-80  text-base-content">
            </ul>
        </div>
    </div>
</div>

<script>
    const userList = document.querySelector("#user-list");
    const messagesContainer = document.querySelector(".messages-container");
    const messageInput = document.querySelector("#message-input");
    const messagesContainerWrapper = document.querySelector(".messages-container-wrapper");
    const MESSAGES_COLORS = [
        'bg-primary',
        'bg-primary-focus',
        'bg-secondary',
        'bg-secondary-focus',
    ];

    function randomMessageColor() {
        return MESSAGES_COLORS[Math.floor(Math.random() * MESSAGES_COLORS.length)]
    }

    fetch("/api/users")
        .then(r => r.json())
        .then(r => {
            for (const user of r.users) {
                const online = Date.now() - user.lastActivityAt < 60000;
                userList.innerHTML += `
                 <li class="border rounded-xl mb-2 ${online ? 'border-primary' : 'border-gray-400'}">
                    <a class="flex justify-between">
                       <strong>${user.username}</strong>
                       <i class="w-3 h-3 rounded-full ${online ? 'bg-primary' : 'bg-gray-400'}"></i>
                    </a>
                 </li>
                `;
            }
        });
    document.querySelector('form').addEventListener("submit", function (event) {
        event.preventDefault();
        const message = messageInput.value;
        if (!message) {
            return;
        }
        fetch("/api/messages", {
            method: "POST",
            body: JSON.stringify({message: message})
        });
        messageInput.value = "";
    });
    let ts = 0;

    function poll() {
        fetch(`/api/messages?ts=${ts}`)
            .then(r => r.json())
            .then(r => {
                for (const message of r.messages) {
                    if (ts < message.sendDate) {
                        ts = message.sendDate;
                    }
                    messagesContainer.innerHTML += `
                        <div class="chat chat-start">
                          <div class="chat-header font-bold mb-1">${message.username}</div>
                          <div class="chat-bubble ${randomMessageColor()}">${message.message}</div>
                        </div>
                    `
                }
                requestAnimationFrame(() => messagesContainerWrapper.scrollTo({top: messagesContainerWrapper.scrollHeight, behavior: 'smooth'}))
                poll();
            })
    }

    poll();
</script>
{{/partial}}
{{> base}}